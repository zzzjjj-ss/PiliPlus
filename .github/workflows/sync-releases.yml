name: Sync Releases from Upstream

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Sync Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "bggRGjQaUbCoE/PiliPlus"
          FORK: "${{ github.repository }}"
        run: |
          echo "Fetching releases from $UPSTREAM"

          gh release list -R $UPSTREAM --limit 200 | awk '{print $1}' > upstream_tags.txt
          gh release list -R $FORK --limit 200 | awk '{print $1}' > fork_tags.txt

          missing=$(comm -23 <(sort upstream_tags.txt) <(sort fork_tags.txt))

          if [ -z "$missing" ]; then
            echo "No new releases to sync."
            exit 0
          fi

          echo "Need to sync:"
          echo "$missing"

          for tag in $missing; do
            echo "Syncing release $tag"

            mkdir -p assets
            gh release download $tag -R $UPSTREAM -D assets/

            notes=$(gh release view $tag -R $UPSTREAM --json body -q .body)

            # 获取所有文件（排除目录）
            files=$(find assets -type f)

            # 如果 Fork 已经存在同名 Release，则删除旧资产
            if gh release view $tag -R $FORK > /dev/null 2>&1; then
              echo "Release $tag already exists in fork. Cleaning old assets..."

              asset_ids=$(gh release view $tag -R $FORK --json assets | jq -r '.assets[].id')

              for id in $asset_ids; do
                gh api \
                  --method DELETE \
                  repos/$FORK/releases/assets/$id
              done
            fi

            # 创建或更新 Release
            if [ -z "$files" ]; then
              echo "No files to upload for $tag"
              gh release create $tag -R $FORK --notes "$notes" --title "$tag" || \
              gh release edit $tag -R $FORK --notes "$notes" --title "$tag"
            else
              gh release create $tag $files -R $FORK --notes "$notes" --title "$tag" || \
              gh release edit $tag $files -R $FORK --notes "$notes" --title "$tag"
            fi

            rm -rf assets
          done
