name: Sync Releases from Upstream

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Sync Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "bggRGjQaUbCoE/PiliPlus"
          FORK: "${{ github.repository }}"
        run: |
          echo "Fetching releases from $UPSTREAM"

          gh release list -R $UPSTREAM --limit 200 | awk '{print $1}' > upstream_tags.txt
          gh release list -R $FORK --limit 200 | awk '{print $1}' > fork_tags.txt

          missing=$(comm -23 <(sort upstream_tags.txt) <(sort fork_tags.txt))

          if [ -z "$missing" ]; then
            echo "No new releases to sync."
            exit 0
          fi

          echo "Need to sync:"
          echo "$missing"

          for tag in $missing; do
            echo "Syncing release $tag"

            # 如果 fork 已经有这个 release，直接删除整个 release
            if gh release view $tag -R $FORK > /dev/null 2>&1; then
              echo "Deleting old release $tag"
              gh release delete $tag -R $FORK -y
            fi

            mkdir -p assets
            gh release download $tag -R $UPSTREAM -D assets/

            notes=$(gh release view $tag -R $UPSTREAM --json body -q .body)

            # 获取所有文件（排除目录）
            files=$(find assets -type f)

            echo "Creating new release $tag"

            if [ -z "$files" ]; then
              gh release create $tag -R $FORK --notes "$notes" --title "$tag"
            else
              gh release create $tag $files -R $FORK --notes "$notes" --title "$tag"
            fi

            rm -rf assets
          done
