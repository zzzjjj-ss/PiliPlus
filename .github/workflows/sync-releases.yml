name: Sync Releases from Upstream

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Sync Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "bggRGjQaUbCoE/PiliPlus"
          FORK: "${{ github.repository }}"
        run: |
          echo "Fetching releases from $UPSTREAM"

          # 获取上游所有 release tag
          gh release list -R $UPSTREAM --limit 200 | awk '{print $1}' > upstream_tags.txt

          for tag in $(cat upstream_tags.txt); do
            echo "Syncing release $tag"

            # 获取上游 release notes
            notes=$(gh release view $tag -R $UPSTREAM --json body -q .body)

            # 如果 fork 没有这个 release，则创建一个空的
            if ! gh release view $tag -R $FORK > /dev/null 2>&1; then
              echo "Creating empty release $tag in fork"
              gh release create $tag -R $FORK --notes "$notes" --title "$tag" || true
            fi

            # 下载上游 release 资产
            rm -rf assets
            mkdir -p assets
            gh release download $tag -R $UPSTREAM -D assets/

            # 获取所有文件（排除目录）
            files=$(find assets -type f)

            # 删除 fork 中同名资产
            asset_ids=$(gh release view $tag -R $FORK --json assets | jq -r '.assets[].id')
            for id in $asset_ids; do
              name=$(gh api repos/$FORK/releases/assets/$id -q .name)
              if echo "$files" | grep -q "$name"; then
                echo "Deleting old asset $name"
                gh api --method DELETE repos/$FORK/releases/assets/$id
              fi
            done

            # 上传新资产
            for f in $files; do
              echo "Uploading asset $f"
              gh release upload $tag "$f" -R $FORK --clobber
            done

          done
